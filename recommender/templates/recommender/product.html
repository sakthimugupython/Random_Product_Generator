{% extends 'recommender/base.html' %}

{% block title %}Product Details - ShopSmart{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="/" class="btn btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back to Products</a>
</div>

<div class="loading" id="loading">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3">Loading product details...</p>
</div>

<div id="productDetails" style="display: none;">
    <div class="row mb-5 g-4">
        <div class="col-md-5">
            <div class="card">
                <div class="product-image" style="height: 400px;">
                    <!-- Image will be loaded here -->
                </div>
            </div>
        </div>
        <div class="col-md-7">
            <div class="card">
                <div class="card-body">
                    <h2 id="productName" class="card-title mb-3"></h2>
                    <span class="badge-category" id="productCategory"></span>
                    
                    <div class="row mt-4 mb-4">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Price</p>
                            <p class="price-tag" id="productPrice"></p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Rating</p>
                            <p class="rating" id="productRating"><i class="fas fa-star"></i> N/A</p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Brand</p>
                            <p class="fw-bold" id="productBrand"></p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-muted mb-1">Stock</p>
                            <p class="fw-bold" id="productStock"></p>
                        </div>
                    </div>

                    <hr>
                    <p id="productDescription" class="text-muted"></p>
                </div>
            </div>
        </div>
    </div>

    <h3 class="section-title"><i class="fas fa-link"></i> Similar Products</h3>
    <p class="text-muted mb-3">Products similar to this one based on features</p>
    <div id="similarProducts" class="row g-4 mb-5">
        <!-- Similar products will be loaded here -->
    </div>

    <h3 class="section-title"><i class="fas fa-heart"></i> Recommended for You</h3>
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <label for="userIdInput" class="form-label"><i class="fas fa-user"></i> Enter Your User ID</label>
                    <input type="number" id="userIdInput" class="form-control" placeholder="e.g., 101" min="1">
                    <small class="text-muted">Enter your user ID to get personalized recommendations</small>
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button class="btn btn-primary w-100" onclick="loadUserRecommendations()">
                        <i class="fas fa-magic"></i> Get Recommendations
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div id="userRecommendations" class="row g-4">
        <!-- User recommendations will be loaded here -->
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const productId = {{ product_id|safe }};

    document.addEventListener('DOMContentLoaded', function() {
        loadProductDetails();
        loadSimilarProducts();
    });

    function loadProductDetails() {
        document.getElementById('loading').style.display = 'block';
        
        fetch(`/api/product/${productId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const product = data.product;
                    document.getElementById('productName').textContent = product.name || 'Product';
                    document.getElementById('productCategory').textContent = product.category || 'N/A';
                    document.getElementById('productPrice').textContent = `₹${product.price || 'N/A'}`;
                    document.getElementById('productRating').innerHTML = `<i class="fas fa-star"></i> ${product.rating || 'N/A'}`;
                    document.getElementById('productBrand').textContent = product.brand || 'N/A';
                    document.getElementById('productStock').textContent = (product.stock || 0) + ' in stock';
                    document.getElementById('productDescription').textContent = product.description || 'No description available';
                    
                    // Update product image
                    const imageUrl = product.image || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400&h=400&fit=crop';
                    document.querySelector('.product-image').innerHTML = `<img src="${imageUrl}" alt="${product.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
                    
                    document.getElementById('productDetails').style.display = 'block';
                }
                document.getElementById('loading').style.display = 'none';
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loading').style.display = 'none';
            });
    }

    function loadSimilarProducts() {
        fetch(`/api/recommend/similar/${productId}/?n=6`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayRecommendations(data.recommendations, 'similarProducts');
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function loadUserRecommendations() {
        const userId = document.getElementById('userIdInput').value;
        
        if (!userId) {
            alert('Please enter a user ID');
            return;
        }

        const container = document.getElementById('userRecommendations');
        container.innerHTML = '<div class="col-12"><div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div></div></div>';

        fetch(`/api/recommend/user/${userId}/?n=6`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    displayRecommendations(data.recommendations, 'userRecommendations');
                } else {
                    container.innerHTML = '<div class="col-12"><p class="text-danger"><i class="fas fa-exclamation-circle"></i> No recommendations available for this user</p></div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                container.innerHTML = '<div class="col-12"><p class="text-danger"><i class="fas fa-exclamation-circle"></i> Error loading recommendations</p></div>';
            });
    }

    function displayRecommendations(products, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        if (!products || products.length === 0) {
            container.innerHTML = '<div class="col-12"><p class="text-muted"><i class="fas fa-inbox"></i> No recommendations available</p></div>';
            return;
        }

        products.forEach(product => {
            const productId = product.id || product.product_id;
            const card = document.createElement('div');
            card.className = 'col-md-4 col-lg-2';
            const imageUrl = product.image || 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=400&h=400&fit=crop';
            card.innerHTML = `
                <div class="card product-card h-100">
                    <div class="product-image" style="height: 150px;">
                        <img src="${imageUrl}" alt="${product.name || 'Product'}">
                    </div>
                    <div class="card-body">
                        <h6 class="card-title">${product.name || 'Product'}</h6>
                        <span class="badge-category" style="font-size: 0.75rem;">${product.category || 'N/A'}</span>
                        <p class="price-tag" style="font-size: 1.1rem; margin: 0.5rem 0;">₹${product.price || 'N/A'}</p>
                        <a href="/product/${productId}/" class="btn btn-primary btn-sm w-100"><i class="fas fa-eye"></i> View</a>
                    </div>
                </div>
            `;
            container.appendChild(card);
        });
    }
</script>
{% endblock %}
